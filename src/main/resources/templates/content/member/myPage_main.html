<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragment/myPage_layout}">

<head>
    <meta charset="UTF-8">
    <title></title>
    <th:block layout:fragment="content_css">
        <link rel="stylesheet" href="/css/member/myPage_main.css">
        <style>
            .s_in {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .s_main {
                width: 800px;
                margin: 30px auto 100px auto;
            }

            .s_title {
                margin-left: 20px;
                width: 150px;
                font-size: 22px;
                font-weight: 700;
                color: #444;
                border-bottom: 5px solid #dadada;
                margin-bottom: 20px;
            }

            .s_tbl {
                width: 1000px;
                margin: 0 auto;
            }

            .s_tbl table {
                width: 100%;
                border-bottom: 1px solid #ddd;
                border-collapse: separate;
                table-layout: fixed;
                font-size: 15px;
            }

            .s_tbl table.board_type th,
            .s_tbl table.board_type td {
                padding: 15px;
                text-align: center;
                border-top: 1px solid #ddd;

            }
            .s_tbl table.board_type{
                margin-bottom: 50px;
            }

            .s_tbl th {
                background-color: #03c75a;
                font-size: 15px;
                font-weight: 600;
            }

            .s_tbl th,
            .s_tbl td {
                text-align: left;
                min-height: 54px;
                padding: 15px 20px;
                font-weight: 400;
                line-height: 23px;
            }

            .s_re_btn {
                background-color: #03c75a;
                color: white;
                padding: 7px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .s_re_btn:hover {
                background-color: #03c75a;
            }

            .s_name {
                color: #fff;
            }
        </style>
    </th:block>
</head>

<body>
    <th:block layout:fragment="content">
        <div class="wrap">
            <div class="s_in">
                <div class="s_main">
                    <h3 class="m1_title">예약내역</h3>
                    <div class="s_tbl">
                        <table class="board_type">
                            <colgroup>
                                <col width="12%" style=" border-radius: 0 0 0 50%;">
                                <col width="20%">
                                <col width="*">
                                <col width="20%">
                                <col width="12%">
                                <col width="18%">
                            </colgroup>
                            <thead>
                                <th class="s_name" style="border-radius: 15px 0 0 0;">예약번호</th>
                                <th class="s_name">예약날짜</th>
                                <th class="s_name">숙소명</th>
                                <th class="s_name">숙박일자</th>
                                <th class="s_name">결제금액</th>
                                <th class="s_name" style="border-radius: 0 15px 0 0;">예약상태</th>
                            </thead>
                            <tbody>
                                <tr th:if="${ #lists.size(Reservationlist) == 0}">
                                    <td colspan="6">
                                        <div class="data_no">
                                            <div class="cont">
                                                <strong>"현재 예약 내역이 존재하지 않습니다."</strong><br>
                                                "즐거운 여행 계획을 준비해 보세요!"
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:each="reserv , state : ${Reservationlist}">
                                    <td><br>[[${reserv.reservationCode}]] <br>
                                    <td>[[${#strings.arraySplit(reserv.reservationDate,' ')[0]}]] <br>
                                        <br>
                                        [[${#strings.arraySplit(reserv.reservationDate,' ')[1]}]]
                                    </td>
                                    <td><span
                                            style="font-size: 20px;">[[${reserv.subAccom.sampleACCVO.accomName}]]</span>

                                        <span><br><br>[[${#strings.arraySplit(reserv.reservationName,' ')[0]}]]</span>
                                    </td>
                                    <td>[[${#strings.arraySplit(reserv.stayStartDate,'T')[0]}]] <br>
                                        ~ <br>
                                        [[${#strings.arraySplit(reserv.stayEndDate,'T')[0]}]]</td>
                                    <td><br>[[${#numbers.formatCurrency(reserv.reservationPrice)}]]</td>
                                    <td
                                        th:if="${reserv.stateVO.refund == 'N' && reserv.stateVO.canRefundDate ge #dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm:ss')}">
                                        예약중
                                        <div><input class="s_re_btn" type="button" value="환불하기" onclick="refund(this)"
                                                th:data-state-code="${reserv.stateVO.reservationStateCode}"
                                                th:data-reservation-price="${reserv.reservationPrice}"
                                                th:data-reservation-date="${reserv.reservationDate}"
                                                th:data-can-refund="${reserv.stateVO.canRefundDate}"
                                                th:data-now-date="${#dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm:ss')}">
                                        </div><!-- 형태에 따라 다른 버튼 -->
                                    </td>
                                    <td
                                        th:if="${reserv.stateVO.refund == 'N' && #dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm:ss') ge reserv.stateVO.canRefundDate && #dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm:ss') lt reserv.stateVO.overDate}">
                                        <div>숙박중</div>
                                    </td>
                                    <td
                                        th:if="${reserv.stateVO.refund == 'N' && reserv.stateVO.review == 'N' && reserv.stateVO.overDate lt #dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm:ss')}">
                                        <div><input class="s_re_btn" type="button" value="리뷰작성하기" onclick="review(this)"
                                                th:data-state-code="${reserv.stateVO.reservationStateCode}"
                                                th:data-reservation-code="${reserv.reservationCode}"></div>
                                    </td>
                                    <td th:if="${reserv.stateVO.review == 'Y' }">
                                        <div>리뷰를 <br> 작성하셨습니다</div>
                                        <input class="s_re_btn" type="button" value="리뷰수정하기"
                                            onclick="reviewUpdate(this)"
                                            th:data-reservation-code="${reserv.reservationCode}">
                                    </td>
                                    <td th:if="${reserv.stateVO.refund == 'Y'}">환불함<br>
                                        [[${#numbers.formatCurrency(reserv.stateVO.refundPrice)}]]
                                    </td>
                                    <input type="hidden">
                                </tr>

                            </tbody>
                        </table>
                    </div>
                    <h3 class="m1_title">찜 목록</h3>
                    <div class="s_tbl">
                        <table class="board_type">
                            <colgroup>
                                <col width="20%" style=" border-radius: 0 0 0 50%;">
                                <col width="20%">
                                <col width="*">
                                <col width="20%">
                                <col width="20%">
                            </colgroup>
                            <thead>
                                <th class="s_name" style="border-radius: 15px 0 0 0;">숙소명</th>
                                <th class="s_name">체크인 & <br>체크아웃</th>
                                <th class="s_name">숙박일자</th>
                                <th class="s_name">결제금액</th>
                                <th class="s_name" style="border-radius: 0 15px 0 0;">결제하기</th>
                            </thead>
                            <tbody>
                                <tr th:if="${ #lists.size(basketList) == 0}">
                                    <td colspan="5">
                                        <div class="data_no">
                                            <div class="cont">
                                                <strong>"현재 결제 대기 목록이 존재하지 않습니다."</strong><br>
                                                "즐거운 여행 계획을 준비해 보세요!"
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:each="basket , state : ${basketList}">
                                    <td>[[${basket.sampleSubVO.sampleACCVO.accomName}]]<br>[[${basket.sampleSubVO.subAccomName}]]
                                    <td>[[${#strings.listSplit(basket.stayStartDate,'T')[1]}]]
                                        <br> [[${#strings.listSplit(basket.stayEndDate,'T')[1]}]]
                                    </td>
                                    <td>[[${#strings.arraySplit(basket.stayStartDate,'T')[0]}]] <br>
                                        ~ <br>
                                        [[${#strings.arraySplit(basket.stayEndDate,'T')[0]}]]</td>
                                    <th:block th:if="${basket.dayuse == 'Y'}">
                                        <td class="Price">[[${basket.sampleSubVO.dayusePrice}]]</td>
                                    </th:block>
                                    <th:block th:if="${basket.dayuse == 'N'}">
                                        <td class="Price">[[${basket.sampleSubVO.accomPrice}]]</td>
                                    </th:block>
                                    <td>
                                        <input class="s_re_btn" type="button" value="결제하기" onclick="basketbuy(this)"
                                            th:data-basket-code="${basket.basketCode}">
                                    </td>
                                    <form action="/buy/buyBasket" method="post">
                                        <input type="hidden" name="stayTerm" class="stayTerm"
                                            th:value="${basket.stayTerm}">
                                        <input type="hidden" name="subAccomCode" th:value="${basket.subAccomCode}">
                                        <input type="hidden" name="stayStartDate" th:value="${basket.stayStartDate}">
                                        <input type="hidden" name="stayEndDate" th:value="${basket.stayEndDate}">
                                        <input type="hidden" name="dayuse" th:value="${basket.dayuse}">
                                        <input type="hidden" class='basketCode' name="basketCode"
                                            th:value="${basket.basketCode}">
                                    </form>
                                </tr>

                            </tbody>
                        </table>

                    </div>
                </div>
                <div class="side">
                    <!-- <div class="s1">
                        <div class="s1_ment1">1:1문의</div>
                        <div class="s1_ment2">궁금하신 사항을 남겨주세요</div>
                        <div class="s1_btn">
                            <button class="s1_btn_left" onclick="location.href='/cs/inquireListForm';">문의내역 확인</button>
                            <button class="s1_btn_right" onclick="location.href='/cs/inquireForm';">문의하기</button>
                        </div>
                    </div> -->
                    <div class="s2"></div>
                    <div class="s3"></div>
                    <div class="s4"></div>
                </div>
            </div>
        </div>
    </th:block>
</body>

<th:block layout:fragment="content_js">
    <script>
        function basketbuy(tag) {
            if (confirm('해당 상품의 결제를 계속하시겠습니까?')) {
                document.querySelector('form[action="/buy/buyBasket"]').submit();

            } else {
                if (confirm('해당 상품의 삭제하시겠습니까?')) {
                    location.href = `/buy/deleteBasketAccom?basketCode=${tag.dataset.basketCode}`
                }
            }
        }

        let Price = document.querySelectorAll('.Price');
        let stayTerm = document.querySelectorAll('.stayTerm');
        for (let i = 0; i < Price.length; i++) {
            Price[i].innerHTML = Number(Price[i].innerHTML) * Number(stayTerm[i].value)
        }

        function refund(tag) {

            console.log(tag.dataset.stateCode)
            console.log(tag.dataset.reservationPrice)
            console.log(tag.dataset.reservationDate)
            console.log(tag.dataset.canRefund)
            console.log(tag.dataset.nowDate)

            console.log((new Date(tag.dataset.nowDate).getTime() - new Date(tag.dataset.reservationDate).getTime()) / (1000 * 60 * 60))//( 1000 * 60 * 60 * 24 )
            let refundPrice = tag.dataset.reservationPrice;
            let refundDay = (new Date(tag.dataset.canRefund).getTime() - new Date(tag.dataset.nowDate).getTime()) / (1000 * 60 * 60 * 24)
            if ((new Date(tag.dataset.nowDate).getTime() - new Date(tag.dataset.reservationDate).getTime()) / (1000 * 60 * 60) > 3) {

                if (refundDay <= 1) {
                    refundPrice = Math.ceil((refundPrice * 0.2) / 100) * 100
                } else if (refundDay <= 3) {
                    refundPrice = Math.ceil((refundPrice * 0.5) / 100) * 100
                } else if (refundDay <= 5) {
                    refundPrice = Math.ceil((refundPrice * 0.7) / 100) * 100
                } else if (refundDay <= 7) {
                    refundPrice = Math.ceil((refundPrice * 0.9) / 100) * 100
                } else if (refundDay <= 10) {
                    refundPrice = Math.ceil((refundPrice * 0.5) / 100) * 100
                }
            }


            if (confirm("환불 하시겠습니까?")) {



                fetch('/buy/refund', { //요청경로
                    method: 'POST',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    //컨트롤러로 전달할 데이터
                    body: new URLSearchParams({
                        reservationStateCode: tag.dataset.stateCode,
                        refund: 'Y',
                        review: 'N',
                        refundPrice: refundPrice,
                        refundDate: tag.dataset.nowDate
                    })
                })
                    .then((response) => {
                        if (!response.ok) {
                            alert('fetch error!\n컨트롤러로 통신중에 오류가 발생했습니다.');
                            return;
                        }

                        return response.text(); //컨트롤러에서 return하는 데이터가 없거나 int, String 일 때 사용
                        //return response.json(); //나머지 경우에 사용
                    })
                    //fetch 통신 후 실행 영역
                    .then((data) => {//data -> controller에서 리턴되는 데이터!
                        location.reload()
                    })
                    //fetch 통신 실패 시 실행 영역
                    .catch(err => {
                        alert('fetch error!\nthen 구문에서 오류가 발생했습니다.\n콘솔창을 확인하세요!');
                        console.log(err);
                    });

            }
        }
        function review(tag) {
            if (confirm("리뷰를 작성 하시겠습니까?")) {

                // fetch('/buy/refund', { //요청경로
                //     method: 'POST',
                //     cache: 'no-cache',
                //     headers: {
                //         'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                //     },
                //     //컨트롤러로 전달할 데이터
                //     body: new URLSearchParams({
                //         reservationStateCode: tag.dataset.stateCode,
                //         refund: 'N',
                //         review: 'Y',
                //         refundPrice: 0
                //     })
                // })
                //     .then((response) => {
                //         if (!response.ok) {
                //             alert('fetch error!\n컨트롤러로 통신중에 오류가 발생했습니다.');
                //             return;
                //         }

                //         return response.text(); //컨트롤러에서 return하는 데이터가 없거나 int, String 일 때 사용
                //         //return response.json(); //나머지 경우에 사용
                //     })
                //     //fetch 통신 후 실행 영역
                //     .then((data) => {//data -> controller에서 리턴되는 데이터!
                //         location.href = "/buy/review?reservationCode=" + tag.dataset.reservationCode;
                //     })
                //     //fetch 통신 실패 시 실행 영역
                //     .catch(err => {
                //         alert('fetch error!\nthen 구문에서 오류가 발생했습니다.\n콘솔창을 확인하세요!');
                //         console.log(err);
                //     });
                location.href = "/buy/review?reservationCode=" + tag.dataset.reservationCode;
            }

        }
        function reviewUpdate(tag) {

            if (confirm("리뷰를 수정 하시겠습니까?")) {
                location.href = "/buy/reviewReset?reservationCode=" + tag.dataset.reservationCode;
            }
        }
    </script>
</th:block>

</html>